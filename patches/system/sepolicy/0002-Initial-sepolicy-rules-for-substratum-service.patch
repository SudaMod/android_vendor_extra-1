From cfce8d300e36d8d77c4ad9cbf7a06858575d706b Mon Sep 17 00:00:00 2001
From: Ivan Iskandar <iiiiskandar14@gmail.com>
Date: Mon, 31 Jul 2017 14:08:27 +0200
Subject: [PATCH 2/3] Initial sepolicy rules for substratum service

Change-Id: I5177363422ae4f8c85d9866fbb94e362d62bae42
Signed-off-by: Harsh Shandilya <harsh@prjkt.io>
---
 private/property_contexts | 1 +
 private/service_contexts  | 1 +
 private/system_app.te     | 4 ++++
 private/system_server.te  | 9 +++++++++
 public/property.te        | 1 +
 public/service.te         | 1 +
 6 files changed, 17 insertions(+)

diff --git a/private/property_contexts b/private/property_contexts
index 8eb2f28b..a6440572 100644
--- a/private/property_contexts
+++ b/private/property_contexts
@@ -24,6 +24,7 @@ ro.hw.                  u:object_r:system_prop:s0
 sys.                    u:object_r:system_prop:s0
 sys.cppreopt            u:object_r:cppreopt_prop:s0
 sys.powerctl            u:object_r:powerctl_prop:s0
+sys.refresh_theme       u:object_r:theme_prop:s0
 sys.usb.ffs.            u:object_r:ffs_prop:s0
 service.                u:object_r:system_prop:s0
 dhcp.                   u:object_r:dhcp_prop:s0
diff --git a/private/service_contexts b/private/service_contexts
index a82243ff..c909941a 100644
--- a/private/service_contexts
+++ b/private/service_contexts
@@ -143,6 +143,7 @@ soundtrigger                              u:object_r:voiceinteraction_service:s0
 statusbar                                 u:object_r:statusbar_service:s0
 storaged                                  u:object_r:storaged_service:s0
 storagestats                              u:object_r:storagestats_service:s0
+substratum                                u:object_r:substratum_service:s0
 SurfaceFlinger                            u:object_r:surfaceflinger_service:s0
 task                                      u:object_r:task_service:s0
 telecom                                   u:object_r:telecom_service:s0
diff --git a/private/system_app.te b/private/system_app.te
index 1dac70ed..28d67a68 100644
--- a/private/system_app.te
+++ b/private/system_app.te
@@ -90,6 +90,10 @@ r_dir_file(system_app, sysfs_type)
 # /data/system access
 allow system_app system_data_file:file r_file_perms;
 
+# Allow access theme data files
+allow system_app theme_data_file:dir create_dir_perms;
+allow system_app theme_data_file:file create_file_perms;
+
 control_logd(system_app)
 read_runtime_log_tags(system_app)
 
diff --git a/private/system_server.te b/private/system_server.te
index df5dbe96..7c1a18a5 100644
--- a/private/system_server.te
+++ b/private/system_server.te
@@ -486,6 +486,10 @@ set_prop(system_server, cppreopt_prop)
 # Collect metrics on boot time created by init
 get_prop(system_server, boottime_prop)
 
+# theme property
+get_prop(system_server, theme_prop)
+set_prop(system_server, theme_prop)
+
 # Read device's serial number from system properties
 get_prop(system_server, serialno_prop)
 
@@ -574,6 +578,7 @@ allow system_server mediadrmserver_service:service_manager find;
 allow system_server netd_service:service_manager find;
 allow system_server nfc_service:service_manager find;
 allow system_server radio_service:service_manager find;
+allow system_server substratum_service:service_manager find;
 allow system_server surfaceflinger_service:service_manager find;
 allow system_server wificond_service:service_manager find;
 
@@ -656,6 +661,10 @@ allow system_server adbd:unix_stream_socket { getattr getopt ioctl read write sh
 # Allow invoking tools like "timeout"
 allow system_server toolbox_exec:file rx_file_perms;
 
+# Allow access theme data files
+allow system_server theme_data_file:dir { create_dir_perms relabelto rw_dir_perms };
+allow system_server theme_data_file:file { create_file_perms relabelto rw_file_perms };
+
 # Postinstall
 #
 # For OTA dexopt, allow calls coming from postinstall.
diff --git a/public/property.te b/public/property.te
index 95efcaa7..8b8e9a2c 100644
--- a/public/property.te
+++ b/public/property.te
@@ -44,6 +44,7 @@ type serialno_prop, property_type;
 type shell_prop, property_type, core_property_type;
 type system_prop, property_type, core_property_type;
 type system_radio_prop, property_type, core_property_type;
+type theme_prop, property_type;
 type vold_prop, property_type, core_property_type;
 type wifi_log_prop, property_type, log_property_type;
 type wifi_prop, property_type;
diff --git a/public/service.te b/public/service.te
index e97b864d..e1f45812 100644
--- a/public/service.te
+++ b/public/service.te
@@ -125,6 +125,7 @@ type settings_service, app_api_service, ephemeral_app_api_service, system_server
 type shortcut_service, app_api_service, system_server_service, service_manager_type;
 type statusbar_service, app_api_service, ephemeral_app_api_service, system_server_service, service_manager_type;
 type storagestats_service, app_api_service, ephemeral_app_api_service, system_server_service, service_manager_type;
+type substratum_service, app_api_service, system_server_service, service_manager_type;
 type task_service, system_server_service, service_manager_type;
 type textclassification_service, app_api_service, ephemeral_app_api_service, system_server_service, service_manager_type;
 type textservices_service, app_api_service, ephemeral_app_api_service, system_server_service, service_manager_type;
-- 
2.17.0

