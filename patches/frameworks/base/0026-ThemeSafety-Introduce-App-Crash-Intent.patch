From 3860f45bf727ea8c85aa849bc2517b7615abd7db Mon Sep 17 00:00:00 2001
From: Ivan Iskandar <ivan@prjkt.io>
Date: Thu, 9 Mar 2017 13:28:22 +0100
Subject: [PATCH 26/37] ThemeSafety: Introduce App Crash Intent

The intent received by substratum and it will disable all enabled
overlays.

Change-Id: Ifabd57c2ea71ca93ecc2959ce09ccde3e91782dd
Signed-off-by: Ivan Iskandar <ivan@prjkt.io>
---
 core/res/AndroidManifest.xml                            | 2 ++
 services/core/java/com/android/server/am/AppErrors.java | 8 ++++++++
 2 files changed, 10 insertions(+)

diff --git a/core/res/AndroidManifest.xml b/core/res/AndroidManifest.xml
index 9ebd541caaf..f66880d0e5e 100644
--- a/core/res/AndroidManifest.xml
+++ b/core/res/AndroidManifest.xml
@@ -551,6 +551,8 @@
     <protected-broadcast android:name="android.media.tv.action.CHANNEL_BROWSABLE_REQUESTED" />
     <protected-broadcast android:name="com.android.server.InputMethodManagerService.SHOW_INPUT_METHOD_PICKER" />
 
+    <protected-broadcast android:name="projekt.substratum.APP_CRASHED" />
+
     <!-- ====================================================================== -->
     <!--                          RUNTIME PERMISSIONS                           -->
     <!-- ====================================================================== -->
diff --git a/services/core/java/com/android/server/am/AppErrors.java b/services/core/java/com/android/server/am/AppErrors.java
index a842724c317..73339363aa1 100644
--- a/services/core/java/com/android/server/am/AppErrors.java
+++ b/services/core/java/com/android/server/am/AppErrors.java
@@ -383,6 +383,14 @@ class AppErrors {
             task = data.task;
             msg.obj = data;
             mService.mUiHandler.sendMessage(msg);
+
+            // Send broadcast intent to alert Substratum
+            Intent intent = new Intent("projekt.substratum.APP_CRASHED");
+            intent.putExtra("projekt.substratum.EXTRA_PACKAGE_NAME", r.info.packageName);
+            intent.putExtra("projekt.substratum.EXTRA_CRASH_REPEATING", data.repeating);
+            intent.putExtra("projekt.substratum.EXTRA_EXCEPTION_CLASS_NAME",
+                            crashInfo.exceptionClassName);
+            mContext.sendBroadcast(intent);
         }
 
         int res = result.get();
-- 
2.18.0

